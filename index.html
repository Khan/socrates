<!DOCTYPE html>
<html>
<head>
<title>Socrates static test page</title>

<style>
.video {
    width: 800px;
}
</style>
</head>

<body>
    <form>
        <label>Youtube id: <input type="text" name="v"></input></label><br>
        <label>Questions url: <input type="text" name="q"></input></label>
        <button type="submit">Load</button>
    </form>


<!-- PackageManager dependencies -->
<script src="/javascript/shared-package/jquery.js"></script>
<script src="/javascript/shared-package/underscore.js"></script>
<script src="/javascript/shared-package/console.js"></script>
<script>KAConsole.enable(true);</script>

<!-- Dynamic package loading -->
<script src="/javascript/shared-package/packageloader.js"></script>
<script src="/javascript/test/packageregistrar.js"></script>

<!-- Some crufty globals that are assumed to exist by KA packages -->
<script src="/javascript/test/globals.js"></script>
<script>
var KA_TEST = {
    PACKAGE_REGISTRAR_DEPS: [
        "jquery.js",
        "underscore.js",
        "console.js",
        "packageloader.js"
    ]
};
</script>

<!-- editor-specific code -->
<script src="js/js-yaml.js"></script>

<script>
// todo(dmnd): build this into PackageManager
var regreq = function() {
    var deps = Array.prototype.slice.call(arguments);
    return PackageManager.register.apply(PackageManager, deps).pipe(function() {
        return PackageManager.require.apply(PackageManager, deps);
    });
};

var createVideoView = function(youtubeId) {
    return regreq("shared.css", "video.css", "video.js").pipe(function() {
        var videoView = new VideoView({youtubeId: youtubeId});
        $("body").append(videoView.el);
        return videoView.whenReady();
    });
};

jsyaml.addConstructor("!bookmark", function(node) {
    var o = this.constructMapping(node);
    o.kind = "bookmark";
    return o;
});

var getSocratesEvents = function(url, youtubeId) {
    return $.get(url).pipe(function(yaml) {
        docs = [];
        jsyaml.loadAll(yaml, function(r) {docs.push(r);});
        return docs;
    }).pipe(function(docs) {
        return regreq("socrates.css", "socrates.js").pipe(function() {
            return _.map(docs, function(doc) {
                if (doc.kind === "bookmark") {
                    return new Socrates.Bookmark(doc);
                } else {
                    doc.template = Handlebars.compile(doc.template);
                    doc.youtubeId = youtubeId;
                    return new Socrates.Question(doc);
                }
            });
        });
    });
};


regreq("shared.js").then(function() {
    var youtubeId = "xyAuNHPsq-g";
    var qs = parseQueryString();
    if ("v" in qs) {
        youtubeId = qs["v"];
    }

    var url = "/socrates/questions/" + youtubeId + ".yaml";
    if ("q" in qs) {
        url = qs["q"];
    }
    $("input[name=v]").val(youtubeId);
    $("input[name=q]").val(url);


    $.when(createVideoView(youtubeId), getSocratesEvents(url, youtubeId)).
    then(function(view, events) {
        Socrates.forView(view, new Backbone.Collection(events));
    });
});

</script>
</body>
</html>
